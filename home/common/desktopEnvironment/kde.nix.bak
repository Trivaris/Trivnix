{
  config,
  lib,
  pkgs,
  ...
}:
let
  inherit (lib) mkIf;
  prefs = config.userPrefs;
in
{
  config = mkIf (prefs.desktopEnvironment == "kde") {
    services = {
      desktopManager.plasma6.enable = true;
      displayManager = {
        defaultSession = "plasma";
        sddm.wayland.compositor = "kwin";
      };
    };

    environment = {
      plasma6.excludePackages = builtins.attrValues {
        inherit (pkgs.kdePackages)
          konsole
          elisa
          ;
      };

      systemPackages = builtins.attrValues {
        inherit (pkgs.kdePackages)
          ksystemlog
          systemsettings
          plasma-browser-integration
          ;
      };
    };

    stylix.targets.qt.platform = lib.mkForce "qtct";
    qt.platformTheme = lib.mkForce "kde";
    vars.desktopEnvironmentBinary = "${pkgs.kde}/bin/startplasma-wayland";
  };
}
